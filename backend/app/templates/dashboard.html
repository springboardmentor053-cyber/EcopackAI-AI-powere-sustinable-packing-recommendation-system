<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoPackAI - BI Dashboard</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>

<body>

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                üåø EcoPack<span class="brand-highlight">AI</span>
            </a>
            <div class="d-flex gap-2">
                <a href="/data-enhancement" class="btn btn-outline-theme rounded-pill px-3">
                    ‚öôÔ∏è AI Training
                </a>
                <a href="/recommendation" class="btn btn-outline-theme rounded-pill px-4">
                    ‚Üê Back to Recommendations
                </a>
            </div>
        </div>
    </nav>

    <div class="container pb-5 pt-4">

        <!-- Header -->
        <div class="dashboard-header mb-5">
            <h1 class="display-4 fw-bold">Sustainability Impact Dashboard</h1>
            <p class="text-secondary fs-4">Real-time insights on cost, carbon footprint, and material efficiency.</p>
        </div>

        <!-- HERO SECTION: Top Recommendation -->
        <div class="recommendation-hero fade-in-up">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <span class="rec-badge">üèÜ Top Recommendation</span>
                    <h2 class="rec-title" id="hero-material">Loading Best Material...</h2>
                    <p class="rec-desc">
                        Based on our AI analysis, this material offers the optimal balance between
                        <strong>Low Carbon Footprint</strong> and <strong>Cost Efficiency</strong>.
                    </p>

                    <div class="rec-stats">
                        <div class="rec-stat-item">
                            <div class="rec-stat-label">Eco Score</div>
                            <div class="rec-stat-value">9.8/10</div>
                        </div>
                        <div class="rec-stat-item">
                            <div class="rec-stat-label">Impact</div>
                            <div class="rec-stat-value text-success">Low</div>
                        </div>
                        <div class="rec-stat-item">
                            <div class="rec-stat-label">Annual Savings</div>
                            <div class="rec-stat-value" id="hero-savings">--%</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 text-center d-none d-lg-block">
                    <!-- Placeholder visual for the material -->
                    <div style="font-size: 8rem;">üì¶</div>
                </div>
            </div>
        </div>

        <!-- KPI Section -->
        <div class="row g-4 mb-5">
            <div class="col-md-4 fade-in-up" style="animation-delay: 0.1s;">
                <div class="kpi-card-new">
                    <div class="kpi-icon-wrapper">
                        üåç
                    </div>
                    <div class="kpi-value-large" id="kpi-co2">--%</div>
                    <div class="kpi-title">CO‚ÇÇ Reduction</div>
                    <div class="trend-badge">
                        <span>‚Üì</span> compared to avg
                    </div>
                </div>
            </div>
            <div class="col-md-4 fade-in-up" style="animation-delay: 0.2s;">
                <div class="kpi-card-new">
                    <div class="kpi-icon-wrapper">
                        üí∞
                    </div>
                    <div class="kpi-value-large" id="kpi-cost">--%</div>
                    <div class="kpi-title">Cost Savings</div>
                    <div class="trend-badge">
                        <span>‚Üì</span> vs market high
                    </div>
                </div>
            </div>
            <div class="col-md-4 fade-in-up" style="animation-delay: 0.3s;">
                <div class="kpi-card-new">
                    <div class="kpi-icon-wrapper">
                        ‚úÖ
                    </div>
                    <div class="kpi-value-large" id="kpi-count">--</div>
                    <div class="kpi-title">Materials Analyzed</div>
                    <div class="text-secondary mt-2 small">Total database items</div>
                </div>
            </div>
        </div>

        <!-- Row 1: Impact Analysis -->
        <div class="row g-4 mb-5">
            <div class="col-lg-6 fade-in-up" style="animation-delay: 0.4s;">
                <div class="chart-box h-100">
                    <div class="chart-header">
                        <h3 class="chart-title">üåç CO‚ÇÇ Emission Analysis</h3>
                        <span class="text-secondary fs-5" title="Average CO2 impact score. Lower is better.">‚ÑπÔ∏è</span>
                    </div>
                    <div id="co2Chart"></div>
                    <div class="insight-box">
                        <strong>Insight:</strong> <span id="co2Insight">Loading data...</span>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 fade-in-up" style="animation-delay: 0.5s;">
                <div class="chart-box h-100">
                    <div class="chart-header">
                        <h3 class="chart-title">üí∞ Cost Efficiency Analysis</h3>
                        <span class="text-secondary fs-5" title="Unit cost comparison (INR).">‚ÑπÔ∏è</span>
                    </div>
                    <div id="costChart"></div>
                    <div class="insight-box">
                        <strong>Insight:</strong> <span id="costInsight">Loading data...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Distribution -->
        <div class="row g-4">
            <div class="col-lg-6 fade-in-up" style="animation-delay: 0.6s;">
                <div class="chart-box h-100">
                    <div class="chart-header">
                        <h3 class="chart-title">üìä Sustainability Score Distribution</h3>
                    </div>
                    <div id="sustChart"></div>
                    <p class="text-secondary mt-3">Distribution of eco-scores across your material inventory.</p>
                </div>
            </div>
            <div class="col-lg-6 fade-in-up" style="animation-delay: 0.7s;">
                <div class="chart-box h-100">
                    <div class="chart-header">
                        <h3 class="chart-title">üì¶ Quantity by Category</h3>
                    </div>
                    <div id="catChart"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', initDashboard);

        async function initDashboard() {
            try {
                const response = await fetch('/api/analytics/data');
                const data = await response.json();

                if (data.error) throw new Error(data.error);

                updateKPIs(data);
                renderCharts(data);
            } catch (error) {
                console.error("Dashboard Error:", error);
                document.getElementById('hero-material').innerText = "Data Unavailable";
                // alert("Failed to load dashboard data."); // Removed alert for smoother UX
            }
        }

        function updateKPIs(data) {
            const kpis = data.kpis;
            if (!kpis) return;

            // Update Hero Section
            document.getElementById('hero-material').innerText = kpis.best_eco_material || "N/A";
            document.getElementById('hero-savings').innerText = kpis.avg_cost_savings + '%';

            // Update KPI Cards
            document.getElementById('kpi-co2').innerText = kpis.avg_co2_reduction + '%';
            document.getElementById('kpi-cost').innerText = kpis.avg_cost_savings + '%';

            // Total Materials (Calculate from data len)
            const totalMaterials = data.sustainability_scores ? data.sustainability_scores.length : '--';
            document.getElementById('kpi-count').innerText = totalMaterials;
        }

        function renderCharts(data) {
            const isDark = true; // Force dark mode for now as per style
            const textColor = '#f1f8e9';
            const gridColor = 'rgba(255,255,255,0.1)';

            const commonLayout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: textColor, family: 'Outfit, sans-serif' },
                margin: { t: 20, b: 40, l: 40, r: 20 },
                xaxis: { gridcolor: gridColor },
                yaxis: { gridcolor: gridColor },
                showlegend: false
            };

            // 1. CO2 Bar Chart
            const co2Sorted = data.co2_emissions.sort((a, b) => a.avg_co2 - b.avg_co2);
            Plotly.newPlot('co2Chart', [{
                x: co2Sorted.map(d => d.material_type),
                y: co2Sorted.map(d => d.avg_co2),
                type: 'bar',
                marker: {
                    color: co2Sorted.map(d => d.avg_co2 < 4 ? '#00e676' : '#ef5350'),
                    line: { width: 0 }
                },
                hovertemplate: '<b>%{x}</b><br>Impact Score: %{y}<extra></extra>'
            }], {
                ...commonLayout,
                yaxis: { title: 'Avg Impact Score', gridcolor: gridColor }
            }, { displayModeBar: false });

            // Insight
            if (co2Sorted.length > 0) {
                const best = co2Sorted[0];
                document.getElementById('co2Insight').innerHTML =
                    `<strong class="text-accent">${best.material_type}</strong> has the lowest environmental footprint among analyzed materials.`;
            }

            // 2. Cost Chart
            const costSorted = data.cost_data.sort((a, b) => a.cost_per_unit_inr - b.cost_per_unit_inr);
            Plotly.newPlot('costChart', [{
                x: costSorted.map(d => d.material_type),
                y: costSorted.map(d => d.cost_per_unit_inr),
                type: 'bar',
                marker: { color: '#29b6f6' },
                hovertemplate: '<b>%{x}</b><br>Cost: ‚Çπ%{y}<extra></extra>'
            }], {
                ...commonLayout,
                yaxis: { title: 'Cost (INR)', gridcolor: gridColor }
            }, { displayModeBar: false });

            if (costSorted.length > 0) {
                const cheapest = costSorted[0];
                document.getElementById('costInsight').innerHTML =
                    `<strong class="text-info">${cheapest.material_type}</strong> is the most cost-effective option at ‚Çπ${cheapest.cost_per_unit_inr}.`;
            }

            // 3. Sustainability Histogram
            Plotly.newPlot('sustChart', [{
                x: data.sustainability_scores,
                type: 'histogram',
                marker: { color: '#ffca28', opacity: 0.8 },
                xbins: { start: 0, end: 10, size: 1 }
            }], {
                ...commonLayout,
                xaxis: { title: 'Eco Score (0-10)', gridcolor: gridColor },
                yaxis: { title: 'Frequency', gridcolor: gridColor }
            }, { displayModeBar: false });

            // 4. Category Pie
            Plotly.newPlot('catChart', [{
                labels: data.category_counts.map(d => d.category),
                values: data.category_counts.map(d => d.material_count),
                type: 'pie',
                hole: 0.5,
                marker: { colors: ['#66bb6a', '#43a047', '#2e7d32', '#1b5e20', '#81c784'] },
                textinfo: 'label+percent',
                textposition: 'outside',
                hoverinfo: 'label+value'
            }], {
                ...commonLayout,
                margin: { t: 0, b: 0, l: 0, r: 0 },
                showlegend: true,
                legend: { orientation: 'h', y: -0.1 }
            }, { displayModeBar: false });
        }
    </script>
</body>

</html>