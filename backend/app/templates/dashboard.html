<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoPackAI - BI Dashboard</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root {
            --primary-green: #00e676;
            --dark-green: #2e7d32;
            --bg-dark: #0a0a0a;
            --card-bg: #1e1e1e;
            --text-light: #f1f8e9;
            --text-muted: #b0bec5;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
        }

        .navbar {
            background-color: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--text-light) !important;
        }

        .brand-highlight {
            color: var(--primary-green);
        }

        .dashboard-header {
            padding: 3rem 0 2rem;
            text-align: center;
        }

        .section-title {
            color: var(--primary-green);
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary-green);
            padding-left: 1rem;
        }

        /* KPI Cards */
        .kpi-card {
            background: linear-gradient(145deg, #2d2d2d, #1a1a1a);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            height: 100%;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-green);
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-green);
            margin: 0.5rem 0;
        }

        .kpi-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Charts */
        .chart-container {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .chart-tooltip-icon {
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-left: 0.5rem;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                üåø EcoPack<span class="brand-highlight">AI</span>
            </a>
            <div class="d-flex">
                <a href="/data-enhancement" class="btn btn-outline-light btn-sm rounded-pill px-3 me-2">
                    ‚öôÔ∏è AI Training
                </a>
                <a href="/recommendation" class="btn btn-outline-light btn-sm rounded-pill px-4">
                    ‚Üê Back to Recommendations
                </a>
            </div>
        </div>
    </nav>

    <div class="container pb-5">

        <!-- Header -->
        <div class="dashboard-header">
            <h1 class="display-5 fw-bold">Sustainability Impact Dashboard</h1>
            <p class="text-muted lead">Real-time insights on cost, carbon footprint, and material efficiency.</p>
        </div>

        <!-- KPI Section -->
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="kpi-card">
                    <div class="kpi-label">Avg. CO‚ÇÇ Reduction</div>
                    <div class="kpi-value" id="kpi-co2">--%</div>
                    <small class="text-muted">vs. High-Impact Materials</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="kpi-card">
                    <div class="kpi-label">Potential Cost Savings</div>
                    <div class="kpi-value" id="kpi-cost">--%</div>
                    <small class="text-muted">vs. Most Expensive Options</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="kpi-card">
                    <div class="kpi-label">Best Eco Material</div>
                    <div class="kpi-value fs-3" id="kpi-best">--</div>
                    <small class="text-muted">Lowest Carbon Footprint</small>
                </div>
            </div>
        </div>

        <!-- Row 1: Impact Analysis -->
        <div class="row g-4 mb-5">
            <div class="col-lg-6">
                <div class="chart-container h-100">
                    <div class="d-flex align-items-center mb-3">
                        <h4 class="mb-0">üåç CO‚ÇÇ Emission Analysis</h4>
                        <span class="chart-tooltip-icon"
                            title="Average CO2 impact score for each material type based on manufacturing and transport. Lower is better.">‚ÑπÔ∏è</span>
                    </div>
                    <div id="co2Chart"></div>
                    <p class="small text-muted mt-3">
                        <strong class="text-success">Insight:</strong> <span id="co2Insight">Loading...</span>
                    </p>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-container h-100">
                    <div class="d-flex align-items-center mb-3">
                        <h4 class="mb-0">üí∞ Cost Efficiency</h4>
                        <span class="chart-tooltip-icon"
                            title="Comparison of unit cost for different materials. Use this to identify budget-friendly eco options.">‚ÑπÔ∏è</span>
                    </div>
                    <div id="costChart"></div>
                    <p class="small text-muted mt-3">
                        <strong class="text-success">Insight:</strong> <span id="costInsight">Loading...</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Row 2: Distribution -->
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="chart-container h-100">
                    <h4 class="mb-3">üìä Sustainability Score Distribution</h4>
                    <div id="sustChart"></div>
                    <div class="alert alert-dark mt-3 small text-muted border-0">
                        Shows how many materials fall into different "Eco-Friendliness" tiers. Most materials should
                        ideally be in the 70-100 range.
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-container h-100">
                    <h4 class="mb-3">üì¶ Material Inventory by Category</h4>
                    <div id="catChart"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', initDashboard);

        async function initDashboard() {
            try {
                const response = await fetch('/api/analytics/data');
                const data = await response.json();

                if (data.error) throw new Error(data.error);

                updateKPIs(data.kpis);
                renderCharts(data);
            } catch (error) {
                console.error("Dashboard Error:", error);
                alert("Failed to load dashboard data.");
            }
        }

        function updateKPIs(kpis) {
            if (!kpis) return;
            // Animate numbers logic could go here, for now direct set
            document.getElementById('kpi-co2').innerText = kpis.avg_co2_reduction + '%';
            document.getElementById('kpi-cost').innerText = kpis.avg_cost_savings + '%';
            document.getElementById('kpi-best').innerText = kpis.best_eco_material;
        }

        function renderCharts(data) {
            const commonLayout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#f1f8e9', family: 'Outfit, sans-serif' },
                margin: { t: 20, b: 60, l: 60, r: 20 },
                xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                yaxis: { gridcolor: 'rgba(255,255,255,0.1)' }
            };

            // 1. CO2 Bar Chart
            const co2Sorted = data.co2_emissions.sort((a, b) => a.avg_co2 - b.avg_co2);
            Plotly.newPlot('co2Chart', [{
                x: co2Sorted.map(d => d.material_type),
                y: co2Sorted.map(d => d.avg_co2),
                type: 'bar',
                marker: { color: co2Sorted.map(d => d.avg_co2 < 4 ? '#00e676' : '#ef5350') } // Green for low, Red for high
            }], {
                ...commonLayout,
                yaxis: { title: 'Avg CO‚ÇÇ Impact Score' }
            });
            // Update Insight Text
            const lowestCo2 = co2Sorted[0];
            document.getElementById('co2Insight').innerText = `${lowestCo2.material_type} has the lowest environmental impact, making it the top green choice.`;

            // 2. Cost Chart
            const costSorted = data.cost_data.sort((a, b) => a.cost_per_unit_inr - b.cost_per_unit_inr);
            Plotly.newPlot('costChart', [{
                x: costSorted.map(d => d.material_type),
                y: costSorted.map(d => d.cost_per_unit_inr),
                type: 'bar', // switched to bar for clarity
                marker: { color: '#29b6f6' }
            }], {
                ...commonLayout,
                yaxis: { title: 'Cost per Unit (INR)' }
            });
            const lowestCost = costSorted[0];
            document.getElementById('costInsight').innerText = `${lowestCost.material_type} is the most budget-friendly option at ‚Çπ${lowestCost.cost_per_unit_inr} per unit.`;

            // 3. Sustainability Histogram
            Plotly.newPlot('sustChart', [{
                x: data.sustainability_scores,
                type: 'histogram',
                marker: { color: '#ffca28' },
                opacity: 0.8
            }], {
                ...commonLayout,
                xaxis: { title: 'Score (0-10) ', gridcolor: 'rgba(255,255,255,0.1)' },
                yaxis: { title: 'Count', gridcolor: 'rgba(255,255,255,0.1)' }
            });

            // 4. Category Pie
            Plotly.newPlot('catChart', [{
                labels: data.category_counts.map(d => d.category),
                values: data.category_counts.map(d => d.material_count),
                type: 'pie',
                hole: 0.4, // Donut chart
                marker: { colors: ['#66bb6a', '#43a047', '#2e7d32', '#1b5e20', '#81c784'] },
                textinfo: 'label+percent',
                textposition: 'inside'
            }], {
                ...commonLayout,
                showlegend: false,
                margin: { t: 0, b: 0, l: 0, r: 0 }
            });
        }
    </script>
</body>

</html>