<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoPackAI - Adaptive Learning</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .form-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .form-header {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                ðŸŒ¿ EcoPack<span class="brand-highlight">AI</span>
            </a>
            <div class="d-flex align-items-center">
                <a href="/dashboard" class="btn btn-outline-theme btn-sm rounded-pill px-4 me-2">
                    Dashboard
                </a>
                <a href="/" class="btn btn-outline-light btn-sm rounded-pill px-4">
                    Home
                </a>
            </div>
        </div>
    </nav>

    <div class="container py-5">

        <div class="text-center mb-5">
            <h1 class="hero-title" style="font-size: 2.5rem;">Adaptive Learning & Data Enhancement</h1>
            <p class="hero-subtitle">
                Enhance the AI's intelligence by continuously updating the knowledge base.
                <br>Data inserted here helps the system learn and improve accuracy.
            </p>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-10">

                <!-- System Status / Retrain -->
                <div class="form-section text-center">
                    <h4>ðŸ”„ System Intelligence Update</h4>
                    <p class="text-secondary mb-4">After updating data below, run this process to recalculate features
                        and retrain ML models.</p>
                    <button id="retrainBtn" class="btn btn-primary px-5">
                        Run Feature Engineering & Retrain Models
                    </button>
                    <div id="retrainStatus" class="mt-3 fw-bold"></div>
                </div>

                <!-- Material Data Form -->
                <div class="form-section">
                    <div class="form-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">ðŸ“¦ Update Material Data</h4>
                        <span class="badge bg-secondary">Table: materials</span>
                    </div>
                    <form id="materialForm">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Material ID (Auto)</label>
                                <input type="number" name="material_id" class="form-control" required
                                    placeholder="Auto-generated" readonly
                                    style="background-color: rgba(255, 255, 255, 0.05); color: var(--text-secondary); cursor: not-allowed;">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">Material Type *</label>
                                <input type="text" name="material_type" class="form-control" required
                                    placeholder="e.g. Bamboo Fiber">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Manufacturing Place</label>
                                <input type="text" name="manufacturing_place" class="form-control"
                                    placeholder="e.g. India">
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Strength (1-10)</label>
                                <input type="number" name="strength" class="form-control" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Weight Cap (kg)</label>
                                <input type="number" name="weight_capacity_kg" class="form-control" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Cost (INR)</label>
                                <input type="number" step="0.01" name="cost_per_unit_inr" class="form-control" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Recycle Days</label>
                                <input type="number" name="recycle_time_days" class="form-control">
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Biodegradability (0-10)</label>
                                <input type="number" name="biodegradability_score" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">COâ‚‚ Emission Score</label>
                                <input type="number" step="0.1" name="co2_emission_score" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Recyclability %</label>
                                <input type="number" name="recyclability_percent" class="form-control">
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Water Resistance (0 or 1)</label>
                                <select name="water_resistance" class="form-select">
                                    <option value="0">No</option>
                                    <option value="1">Yes</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 text-end">
                            <button type="submit" class="btn btn-success">Save Material Record</button>
                        </div>
                    </form>
                </div>

                <!-- Product Mapping Form -->
                <div class="form-section">
                    <div class="form-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">ðŸ”— Map Product Category</h4>
                        <span class="badge bg-secondary">Table: product_material</span>
                    </div>
                    <form id="productForm">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Material ID (Auto)</label>
                                <input type="number" name="material_id" class="form-control" required
                                    placeholder="Auto-matched" readonly
                                    style="background-color: rgba(255, 255, 255, 0.05); color: var(--text-secondary); cursor: not-allowed;">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Category *</label>
                                <select name="category" class="form-select" required id="categorySelect">
                                    <option value="Electronics">Electronics</option>
                                    <option value="Food">Food / Perishable</option>
                                    <option value="Clothing">Clothing</option>
                                    <option value="Furniture">Furniture</option>
                                    <option value="Gadgets">Gadgets</option>
                                    <option value="Home Essentials">Home Essentials</option>
                                    <option value="Toys">Toys</option>
                                    <option value="Personal Care">Personal Care</option>
                                    <option value="Other">Other</option>
                                </select>
                                <input type="text" id="customCategoryInput" name="custom_category"
                                    class="form-control mt-2" placeholder="Enter custom category name"
                                    style="display:none;">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Eco Alternative Name</label>
                                <input type="text" name="eco_alternative" class="form-control"
                                    placeholder="e.g. EcoBox">
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Max Weight Capacity (Upto kg)</label>
                                <input type="number" name="weight_capacity_upto" class="form-control"
                                    placeholder="Optional limit">
                            </div>
                        </div>
                        <div class="mt-4 text-end">
                            <button type="submit" class="btn btn-success">Save Mapping</button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showAlert(msg, type = 'success') {
            alert(msg); // Simple alert for now
        }

        async function fetchNextId() {
            try {
                const res = await fetch('/api/learning/next-id');
                const data = await res.json();
                if (data.success) {
                    const idInput = document.querySelector('input[name="material_id"]');
                    if (idInput) idInput.value = data.next_id;

                    // Also update the Product Form ID for convenience
                    const prodIdInput = document.querySelector('#productForm input[name="material_id"]');
                    if (prodIdInput) prodIdInput.value = data.next_id;
                }
            } catch (err) {
                console.error("Failed to fetch next ID:", err);
            }
        }

        // Load ID on startup
        document.addEventListener('DOMContentLoaded', fetchNextId);

        document.getElementById('materialForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            // Convert numbers
            ['material_id', 'strength', 'weight_capacity_kg', 'cost_per_unit_inr', 'biodegradability_score', 'co2_emission_score', 'recyclability_percent', 'water_resistance', 'recycle_time_days'].forEach(k => {
                if (data[k]) data[k] = parseFloat(data[k]);
            });

            try {
                const res = await fetch('/api/learning/update-material', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                showAlert(result.message, result.success ? 'success' : 'error');
                if (result.success) {
                    e.target.reset();
                    fetchNextId(); // Get next ID after save
                }
            } catch (err) {
                showAlert("Error: " + err.message, 'error');
            }
        });

        // Custom Category Logic
        const catSelect = document.getElementById('categorySelect');
        const customInput = document.getElementById('customCategoryInput');

        if (catSelect && customInput) {
            catSelect.addEventListener('change', (e) => {
                if (e.target.value === 'Other') {
                    customInput.style.display = 'block';
                    customInput.required = true;
                    customInput.focus();
                } else {
                    customInput.style.display = 'none';
                    customInput.required = false;
                    customInput.value = '';
                }
            });
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            // Handle Custom Category
            if (data['category'] === 'Other' && data['custom_category']) {
                data['category'] = data['custom_category'].trim();
            }
            if (!data['category']) {
                showAlert("Please enter a category name", "error");
                return;
            }
            delete data['custom_category']; // Clean request

            if (data['material_id']) data['material_id'] = parseFloat(data['material_id']);
            if (data['weight_capacity_upto']) data['weight_capacity_upto'] = parseFloat(data['weight_capacity_upto']);

            try {
                const res = await fetch('/api/learning/update-product', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                showAlert(result.message, result.success ? 'success' : 'error');
                if (result.success) e.target.reset();
            } catch (err) {
                showAlert("Error: " + err.message, 'error');
            }
        });

        document.getElementById('retrainBtn').addEventListener('click', async () => {
            const btn = document.getElementById('retrainBtn');
            const status = document.getElementById('retrainStatus');

            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Processing...`;
            status.innerHTML = "Engineering Features & Training Models...";
            status.className = "mt-3 text-warning";

            try {
                const res = await fetch('/api/learning/retrain', { method: 'POST' });
                const result = await res.json();

                status.innerHTML = result.message;
                status.className = result.success ? "mt-3 text-success" : "mt-3 text-danger";
            } catch (err) {
                status.innerHTML = "Error: " + err.message;
                status.className = "mt-3 text-danger";
            } finally {
                btn.disabled = false;
                btn.innerHTML = "Run Feature Engineering & Retrain Models";
            }
        });
    </script>
</body>

</html>